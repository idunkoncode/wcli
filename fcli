#!/usr/bin/env bash
# fcli - Fedora Linux CLI wrapper tool

set -euo pipefail

# Configuration paths
FEDORA_CONFIG_DIR="${FEDORA_CONFIG_DIR:-${HOME}/.config/fedora-config}"
CONFIG_FILE="${FEDORA_CONFIG_DIR}/config.yaml"
PACKAGES_DIR="${FEDORA_CONFIG_DIR}/packages"
STATE_DIR="${FEDORA_CONFIG_DIR}/state"
STATE_FILE="${STATE_DIR}/installed.yaml"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper function
print_help() {
  cat << EOF
fcli - Fedora Linux CLI wrapper tool

Setup:
  fcli init                  - Initialize fedora-config directory structure

Package Management:
  fcli update                - Update system with dnf (sudo dnf update -y)
  fcli <package-name>        - Search for package with dnf
  fcli install <package>     - Install package with dnf (sudo dnf install -y)
  fcli remove <package>      - Remove package with dnf (sudo dnf remove -y)

Declarative Package Management:
  fcli sync                  - Install packages to match configuration
  fcli sync -d, --dry-run    - Preview changes without applying
  fcli sync --prune          - Remove packages not in configuration
  fcli sync --force          - Skip confirmation prompts
  fcli sync --no-backup      - Skip automatic Timeshift backup
  fcli status                - Show current configuration and sync status

  fcli module list           - Show all available modules and their status
  fcli module enable <name>    - Enable a module
  fcli module disable <name>   - Disable a module

Timeshift Commands:
  (Requires: sudo dnf install timeshift)
  fcli backup                - Create snapshot (timeshift --create)

Repository Management:
  fcli repo init             - Set up git for fedora-config (first computer)
  fcli repo clone            - Clone existing fedora-config (new computer)
  fcli repo push             - Commit and push changes
  fcli repo pull             - Pull updates from other machines
  fcli repo status           - Show git status
  fcli backup list           - List snapshots (timeshift --list)
  fcli restore               - Restore snapshot interactively (timeshift --restore)
  fcli restore <snapshot>    - Restore specific snapshot (timeshift --restore --snapshot)
  fcli -d <snapshot>         - Delete snapshot (timeshift --delete --snapshot)
  fcli -c backup             - Check snapshot integrity (timeshift --check)

  help                       - Show this help message
EOF
}

# Check if yq is installed
check_yq() {
  if ! command -v yq &> /dev/null; then
    echo -e "${RED}Error: yq is required but not installed${NC}" >&2
    echo "Install with: sudo dnf install yq" >&2
    exit 1
  fi
}

# Check if timeshift is installed
check_timeshift() {
  if ! command -v timeshift &> /dev/null; then
    echo -e "${RED}Error: timeshift is required but not installed${NC}" >&2
    echo "Install with: sudo dnf install timeshift" >&2
    exit 1
  fi
}

# Load config.yaml
load_config() {
  if [ ! -f "$CONFIG_FILE" ]; then
    echo -e "${RED}Error: Configuration file not found: $CONFIG_FILE${NC}" >&2
    exit 1
  fi
  cat "$CONFIG_FILE"
}

# Get all packages that should be installed
get_declared_packages() {
  check_yq

  local config
  config=$(load_config)

  local hostname
  hostname=$(echo "$config" | yq '.host')

  local enabled_modules
  enabled_modules=$(echo "$config" | yq '.enabled_modules[]' 2>/dev/null || true)

  local all_packages=()
  local excluded_packages=()

  # 1. Load base packages
  if [ -f "${PACKAGES_DIR}/base.yaml" ]; then
    while IFS= read -r pkg; do
      all_packages+=("$pkg")
    done < <(yq '.packages[]' "${PACKAGES_DIR}/base.yaml")
  fi

  # 2. Load host-specific packages
  local host_file="${PACKAGES_DIR}/hosts/${hostname}.yaml"
  if [ -f "$host_file" ]; then
    while IFS= read -r pkg; do
      all_packages+=("$pkg")
    done < <(yq '.packages[]' "$host_file")

    # Get exclusions
    while IFS= read -r pkg; do
      excluded_packages+=("$pkg")
    done < <(yq '.exclude[]?' "$host_file" 2>/dev/null || true)
  fi

  # 3. Load enabled module packages
  if [ -n "$enabled_modules" ]; then
    while IFS= read -r module; do
      local module_file="${PACKAGES_DIR}/modules/${module}.yaml"
      if [ -f "$module_file" ]; then
        while IFS= read -r pkg; do
          all_packages+=("$pkg")
        done < <(yq '.packages[]' "$module_file")
      fi
    done <<< "$enabled_modules"
  fi

  # 4. Load additional packages from config
  while IFS= read -r pkg; do
    [ -n "$pkg" ] && all_packages+=("$pkg")
  done < <(echo "$config" | yq '.additional_packages[]?' 2>/dev/null || true)

  # Remove duplicates and excluded packages
  local unique_packages
  unique_packages=$(printf '%s\n' "${all_packages[@]}" | sort -u)

  # Filter out excluded packages
  if [ ${#excluded_packages[@]} -gt 0 ]; then
    for excluded in "${excluded_packages[@]}"; do
      unique_packages=$(echo "$unique_packages" | grep -v "^${excluded}$" || true)
    done
  fi

  echo "$unique_packages"
}

# Get currently installed packages
get_installed_packages() {
  # rpm -qa --qf '%{NAME}\n' lists all installed package names
  rpm -qa --qf '%{NAME}\n'
}

# Create Timeshift backup
create_backup() {
  check_timeshift
  echo -e "${BLUE}Creating Timeshift snapshot before sync...${NC}"
  if ! sudo timeshift --create --comments "fcli sync autobackup" --scripted > /dev/null 2>&1; then
    echo -e "${YELLOW}Warning: Failed to create Timeshift backup${NC}"
    echo -e "${YELLOW}Continuing anyway...${NC}"
  else
    echo -e "${GREEN}Backup created successfully${NC}"
  fi
}

# Sync packages
cmd_sync() {
  local dry_run=false
  local prune=false
  local force=false
  local no_backup=false

  # Parse flags
  while [[ $# -gt 0 ]]; do
    case $1 in
      -d|--dry-run)
        dry_run=true
        shift
        ;;
      --prune)
        prune=true
        shift
        ;;
      --force)
        force=true
        shift
        ;;
      --no-backup)
        no_backup=true
        shift
        ;;
      *)
        echo -e "${RED}Error: Unknown option: $1${NC}" >&2
        exit 1
        ;;
    esac
  done

  echo -e "${BLUE}Loading package configuration...${NC}"

  local config
  config=$(load_config)

  local enabled_modules
  enabled_modules=$(echo "$config" | yq '.enabled_modules[]' 2>/dev/null || true)

  local declared_packages
  declared_packages=$(get_declared_packages)

  local installed_packages
  installed_packages=$(get_installed_packages)

  # Find packages to install
  local to_install=()
  while IFS= read -r pkg; do
    if ! echo "$installed_packages" | grep -q "^${pkg}$"; then
      to_install+=("$pkg")
    fi
  done <<< "$declared_packages"

  # Find packages to remove (only if pruning)
  local to_remove=()
  if [ "$prune" = true ]; then
    # Load state file to see what we previously installed
    if [ -f "$STATE_FILE" ]; then
      local managed_packages
      managed_packages=$(yq '.packages[]' "$STATE_FILE" 2>/dev/null || true)

      while IFS= read -r pkg; do
        if ! echo "$declared_packages" | grep -q "^${pkg}$"; then
          # Package was managed but is no longer declared
          if echo "$installed_packages" | grep -q "^${pkg}$"; then
            to_remove+=("$pkg")
          fi
        fi
      done <<< "$managed_packages"
    fi
  fi

  # Display summary
  echo ""
  echo -e "${BLUE}=== Sync Summary ===${NC}"

  if [ ${#to_install[@]} -gt 0 ]; then
    echo -e "${GREEN}Packages to install (${#to_install[@]}):${NC}"
    printf '  %s\n' "${to_install[@]}"
  else
    echo -e "${GREEN}No packages to install${NC}"
  fi

  echo ""

  if [ ${#to_remove[@]} -gt 0 ]; then
    echo -e "${YELLOW}Packages to remove (${#to_remove[@]}):${NC}"
    printf '  %s\n' "${to_remove[@]}"
  elif [ "$prune" = true ]; then
    echo -e "${GREEN}No packages to remove${NC}"
  fi

  # Exit if dry run
  if [ "$dry_run" = true ]; then
    echo ""
    echo -e "${BLUE}Dry run - no changes made${NC}"
    exit 0
  fi

  # Check if we need to run post-install hooks even if no packages to install/remove
  local need_hooks=false
  if [ -n "$enabled_modules" ]; then
    while IFS= read -r module; do
      local module_file="${PACKAGES_DIR}/modules/${module}.yaml"
      if [ -f "$module_file" ]; then
        local post_hook
        post_hook=$(yq '.post_install_hook?' "$module_file" 2>/dev/null || echo "")
        if [ -n "$post_hook" ] && [ "$post_hook" != "null" ]; then
          need_hooks=true
          break
        fi
      fi
    done <<< "$enabled_modules"
  fi

  # Exit if nothing to do and no hooks to run
  if [ ${#to_install[@]} -eq 0 ] && [ ${#to_remove[@]} -eq 0 ] && [ "$need_hooks" = false ]; then
    echo ""
    echo -e "${GREEN}System is already in sync!${NC}"
    exit 0
  fi

  # Confirm unless --force (only if there are changes to make)
  if [ "$force" = false ] && { [ ${#to_install[@]} -gt 0 ] || [ ${#to_remove[@]} -gt 0 ]; }; then
    echo ""
    read -p "Apply these changes? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      echo -e "${YELLOW}Cancelled${NC}"
      exit 0
    fi
  fi

  # Create backup unless --no-backup
  if [ "$no_backup" = false ]; then
    create_backup
  fi

  # Install packages
  if [ ${#to_install[@]} -gt 0 ]; then
    echo ""
    echo -e "${BLUE}Installing packages...${NC}"
    if ! sudo dnf install -y "${to_install[@]}"; then
      echo -e "${RED}Error: Failed to install packages${NC}" >&2
      exit 1
    fi
    echo -e "${GREEN}Packages installed successfully${NC}"
  fi

  # Remove packages
  if [ ${#to_remove[@]} -gt 0 ]; then
    echo ""
    echo -e "${BLUE}Removing packages...${NC}"
    if ! sudo dnf remove -y "${to_remove[@]}"; then
      echo -e "${RED}Error: Failed to remove packages${NC}" >&2
      exit 1
    fi
    echo -e "${GREEN}Packages removed successfully${NC}"
  fi

  # Run post-install hooks for enabled modules
  if [ -n "$enabled_modules" ]; then
    while IFS= read -r module; do
      local module_file="${PACKAGES_DIR}/modules/${module}.yaml"
      if [ -f "$module_file" ]; then
        local post_hook
        post_hook=$(yq '.post_install_hook?' "$module_file" 2>/dev/null || echo "")

        if [ -n "$post_hook" ] && [ "$post_hook" != "null" ]; then
          local hook_script="${FEDORA_CONFIG_DIR}/${post_hook}"
          if [ -f "$hook_script" ]; then
            echo ""
            echo -e "${BLUE}Running post-install hook for '${module}'...${NC}"
            if sudo bash "$hook_script"; then
              echo -e "${GREEN}Post-install hook completed successfully${NC}"
            else
              echo -e "${YELLOW}Warning: Post-install hook failed for '${module}'${NC}"
            fi
          fi
        fi
      fi
    done <<< "$enabled_modules"
  fi

  # Update state file
  mkdir -p "$STATE_DIR"
  { echo "packages:"; echo "$declared_packages" | sed 's/^/  - /'; } > "$STATE_FILE"

  echo ""
  echo -e "${GREEN}Sync complete!${NC}"
}

# Module list command
cmd_module_list() {
  check_yq

  local config
  config=$(load_config)

  local enabled_modules
  enabled_modules=$(echo "$config" | yq '.enabled_modules[]' 2>/dev/null || echo "")

  echo -e "${BLUE}=== Available Modules ===${NC}"
  echo ""

  for module_file in "${PACKAGES_DIR}/modules"/*.yaml; do
    if [ -f "$module_file" ]; then
      local module_name
      module_name=$(basename "$module_file" .yaml)

      local description
      description=$(yq '.description' "$module_file")

      local conflicts
      conflicts=$(yq '.conflicts[]?' "$module_file" 2>/dev/null | tr '\n' ',' | sed 's/,$//')

      local pkg_count
      pkg_count=$(yq '.packages | length' "$module_file")

      local status="disabled"
      if echo "$enabled_modules" | grep -q "^${module_name}$"; then
        status="${GREEN}enabled${NC}"
      else
        status="${YELLOW}disabled${NC}"
      fi

      echo -e "  ${BLUE}${module_name}${NC} [${status}]"
      echo -e "    ${description}"
      echo -e "    Packages: ${pkg_count}"
      if [ -n "$conflicts" ]; then
        echo -e "    ${RED}Conflicts with: ${conflicts}${NC}"
      fi
      echo ""
    fi
  done
}

# Module enable command
cmd_module_enable() {
  check_yq

  local module_name="$1"
  local module_file="${PACKAGES_DIR}/modules/${module_name}.yaml"

  if [ ! -f "$module_file" ]; then
    echo -e "${RED}Error: Module '${module_name}' not found${NC}" >&2
    echo "Run 'fcli module list' to see available modules" >&2
    exit 1
  fi

  local config
  config=$(load_config)

  # Check if already enabled
if echo "$config" | yq -e '.enabled_modules[] | select(. == "'${module_name}'")' | grep -q . > /dev/null 2>&1; then
    echo -e "${YELLOW}Module '${module_name}' is already enabled${NC}"
    exit 0
  fi

  # Check for conflicts
  local conflicts
  conflicts=$(yq '.conflicts[]?' "$module_file" 2>/dev/null || true)

  if [ -n "$conflicts" ]; then
    local enabled_modules
    enabled_modules=$(echo "$config" | yq '.enabled_modules[]' 2>/dev/null || true)

    while IFS= read -r conflict; do
      if echo "$enabled_modules" | grep -q "^${conflict}$"; then
        echo -e "${RED}Warning: Module '${module_name}' conflicts with enabled module '${conflict}'${NC}"
        read -p "Disable '${conflict}' and enable '${module_name}'? [y/N] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
          # Disable conflicting module
          yq -i ".enabled_modules = (.enabled_modules - [\"${conflict}\"])" "$CONFIG_FILE"
        else
          echo -e "${YELLOW}Cancelled${NC}"
          exit 0
        fi
      fi
    done <<< "$conflicts"
  fi

  # Enable module
  yq -i ".enabled_modules += [\"${module_name}\"]" "$CONFIG_FILE"

  echo -e "${GREEN}Module '${module_name}' enabled${NC}"
  echo "Run 'fcli sync' to install packages"
}

# Module disable command
cmd_module_disable() {
  check_yq

  local module_name="$1"

  local config
  config=$(load_config)

  # Check if enabled
if ! echo "$config" | yq -e '.enabled_modules[] | select(. == "'${module_name}'")' | grep -q . > /dev/null 2>&1; then
    echo -e "${YELLOW}Module '${module_name}' is not enabled${NC}"
    exit 0
  fi

  # Disable module
  yq -i ".enabled_modules = (.enabled_modules - [\"${module_name}\"])" "$CONFIG_FILE"

  echo -e "${GREEN}Module '${module_name}' disabled${NC}"
  echo "Run 'fcli sync --prune' to remove packages"
}

# Status command
cmd_status() {
  check_yq

  local config
  config=$(load_config)

  local hostname
  hostname=$(echo "$config" | yq '.host')

  local enabled_modules
  enabled_modules=$(echo "$config" | yq '.enabled_modules[]' 2>/dev/null || true)

  local auto_prune
  auto_prune=$(echo "$config" | yq '.auto_prune')

  echo -e "${BLUE}=== Configuration Status ===${NC}"
  echo ""
  echo -e "  Hostname: ${GREEN}${hostname}${NC}"
  echo -e "  Auto-prune: ${auto_prune}"
  echo ""

  echo -e "${BLUE}Enabled Modules:${NC}"
  if [ -z "$enabled_modules" ]; then
    echo "  (none)"
  else
    while IFS= read -r module; do
      echo "  - $module"
    done <<< "$enabled_modules"
  fi
  echo ""

  # Check for conflicts
  local has_conflicts=false
  while IFS= read -r module1; do
    local module_file1="${PACKAGES_DIR}/modules/${module1}.yaml"
    if [ -f "$module_file1" ]; then
      local conflicts1
      conflicts1=$(yq '.conflicts[]?' "$module_file1" 2>/dev/null || true)

      while IFS= read -r conflict; do
        if echo "$enabled_modules" | grep -q "^${conflict}$"; then
          if [ "$has_conflicts" = false ]; then
            echo -e "${RED}Conflicts detected:${NC}"
            has_conflicts=true
          fi
          echo -e "  ${RED}⚠${NC} Module '${module1}' conflicts with '${conflict}'"
        fi
      done <<< "$conflicts1"
    fi
  done <<< "$enabled_modules"

  if [ "$has_conflicts" = true ]; then
    echo ""
  fi

  # Package summary
  local declared_packages
  declared_packages=$(get_declared_packages)

  local declared_count
  declared_count=$(echo "$declared_packages" | wc -l)

  local installed_packages
  installed_packages=$(get_installed_packages)

  local to_install=0
  while IFS= read -r pkg; do
    if ! echo "$installed_packages" | grep -q "^${pkg}$"; then
      ((to_install++))
    fi
  done <<< "$declared_packages"

  echo -e "${BLUE}Packages:${NC}"
  echo "  Declared: ${declared_count}"
  echo "  To install: ${to_install}"

  if [ "$to_install" -gt 0 ]; then
    echo ""
    echo -e "${YELLOW}System is out of sync. Run 'fcli sync' to install packages.${NC}"
  else
    echo ""
    echo -e "${GREEN}System is in sync!${NC}"
  fi
}

# Initialize fedora-config directory structure
cmd_init() {
  echo -e "${BLUE}Initializing fedora-config directory structure...${NC}"
  echo ""

  # Check if fedora-config already exists
  if [ -d "$FEDORA_CONFIG_DIR" ]; then
    echo -e "${YELLOW}Warning: $FEDORA_CONFIG_DIR already exists${NC}"
    read -p "Do you want to reinitialize? This will backup existing files. [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      echo -e "${YELLOW}Cancelled${NC}"
      exit 0
    fi

    # Backup existing directory
    local backup_dir="${FEDORA_CONFIG_DIR}.backup.$(date +%s)"
    echo -e "${BLUE}Backing up existing directory to: ${backup_dir}${NC}"
    mv "$FEDORA_CONFIG_DIR" "$backup_dir"
  fi

  # Create directory structure
  mkdir -p "$FEDORA_CONFIG_DIR"
  mkdir -p "$PACKAGES_DIR/hosts"
  mkdir -p "$PACKAGES_DIR/modules"
  mkdir -p "$STATE_DIR"
  mkdir -p "$FEDORA_CONFIG_DIR/scripts"
  mkdir -p "$FEDORA_CONFIG_DIR/udev-rules"

  # Get hostname
  local hostname
  hostname=$(hostname)

  # Create config.yaml
  cat > "$CONFIG_FILE" << EOF
# Main configuration for fcli declarative package management
# Edit this file to customize your system configuration

# Hostname of this machine
host: $hostname

# List of enabled modules
# Enable modules with: fcli module enable <module-name>
enabled_modules: []

# Additional packages not in any module
additional_packages: []

# Automatically remove unmanaged packages during sync
auto_prune: false
EOF

  echo -e "${GREEN}✓${NC} Created config.yaml with hostname: $hostname"

  # Create base.yaml
  cat > "$PACKAGES_DIR/base.yaml" << 'EOF'
# Base packages installed on all machines
# These packages form the foundation of your system

description: Base packages for all machines

packages:
  # @core is a dnf group that includes the base system
  - "@core"
  - kernel
  - linux-firmware
  - NetworkManager
  - vim-enhanced
  - git
  - yq  # YAML processor for fcli
EOF

  echo -e "${GREEN}✓${NC} Created packages/base.yaml"

  # Create host-specific package file
  cat > "$PACKAGES_DIR/hosts/${hostname}.yaml" << EOF
# Host-specific packages for $hostname
# Add packages unique to this machine (drivers, hardware-specific tools, etc.)
description: Packages specific to $hostname

# Packages to install on this host
# e.g., @development-tools, @c-development
packages: []

# Packages to exclude from base or modules on this host
exclude: []
EOF

  echo -e "${GREEN}✓${NC} Created packages/hosts/${hostname}.yaml"

  # Create .gitignore in state directory
  cat > "$STATE_DIR/.gitignore" << EOF
# Auto-generated state files
installed.yaml
EOF

  echo -e "${GREEN}✓${NC} Created state/.gitignore"

  # Create example module
  cat > "$PACKAGES_DIR/modules/example.yaml" << 'EOF'
# Example module template
# Copy this to create new modules, or delete it

description: Example module - customize or delete this

# List of packages in this module
packages: []

# Modules that conflict with this one
conflicts: []

# Script to run after installing packages (optional)
post_install_hook: ""
EOF

  echo -e "${GREEN}✓${NC} Created example module"

  # Create README.md
  cat > "$FEDORA_CONFIG_DIR/README.md" << EOF
# fedora-config

Declarative package management configuration for Fedora Linux.

## Structure

- \`config.yaml\` - Main configuration file
- \`packages/base.yaml\` - Base packages for all machines
- \`packages/hosts/\` - Host-specific package configurations
- \`packages/modules/\` - Optional package modules
- \`scripts/\` - Post-install hook scripts
- \`udev-rules/\` - Custom udev rules
- \`state/\` - Auto-generated state files (git-ignored)

## Usage

### Add base packages
Edit \`packages/base.yaml\` to add packages that should be installed on all machines.

### Add host-specific packages
Edit \`packages/hosts/${hostname}.yaml\` to add packages specific to this machine.

### Create and enable modules
1. Create a new YAML file in \`packages/modules/\`
2. Enable it with: \`fcli module enable <module-name>\`
3. Sync packages: \`fcli sync\`

### Sync packages
\`\`\`bash
fcli sync          # Preview and install missing packages
fcli sync --prune  # Also remove packages not in configuration
\`\`\`

## Git Integration

Initialize a git repository to track your configuration:

\`\`\`bash
cd $FEDORA_CONFIG_DIR
git init
git add .
git commit -m "Initial fedora-config setup"
\`\`\`

The \`state/installed.yaml\` file is auto-generated and git-ignored.
EOF

  echo -e "${GREEN}✓${NC} Created README.md"

  echo ""
  echo -e "${GREEN}Initialization complete!${NC}"
  echo ""
  echo "Next steps:"
  echo "  1. Edit $PACKAGES_DIR/base.yaml to add your base packages"
  echo "  2. Edit $PACKAGES_DIR/hosts/${hostname}.yaml for host-specific packages"
  echo "  3. Create modules in $PACKAGES_DIR/modules/"
  echo "  4. Run 'fcli repo init' to version control your config (recommended)"
  echo "  5. Run 'fcli sync' to install packages"
  echo "  git commit -m 'Initial fedora-config setup'"
}

# ============================================================================
# Git Repository Management Functions
# ============================================================================

# Check if current directory is a git repository
check_git_repo() {
  if [ ! -d "$FEDORA_CONFIG_DIR/.git" ]; then
    return 1
  fi
  return 0
}

# Validate git URL format
validate_git_url() {
  local url="$1"
  if [[ "$url" =~ ^(https://|git@).+\.git$ ]] || [[ "$url" =~ ^(https://|git@).+$ ]]; then
    return 0
  fi
  return 1
}

# Handle common git errors
handle_git_error() {
  local exit_code=$1
  local operation=$2
  
  if [ $exit_code -ne 0 ]; then
    echo -e "${RED}Error during: $operation${NC}"
    
    case $operation in
      "push"|"clone")
        echo -e "${YELLOW}Authentication may have failed.${NC}"
        echo ""
        echo "For HTTPS URLs:"
        echo "  • You may need a Personal Access Token instead of password"
        echo "  • GitHub: https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token"
        echo "  • GitLab: https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html"
        echo ""
        echo "For SSH URLs:"
        echo "  • Ensure your SSH key is added to your account"
        echo "  • Test with: ssh -T git@github.com (or git@gitlab.com)"
        ;;
      "pull")
        echo -e "${YELLOW}There may be merge conflicts.${NC}"
        echo "  • Run: cd $FEDORA_CONFIG_DIR && git status"
        echo "  • Resolve conflicts manually, then: git add . && git commit"
        ;;
    esac
    return 1
  fi
  return 0
}

# ============================================================================
# Repository Commands
# ============================================================================

# Initialize git repository
cmd_repo_init() {
  cd "$FEDORA_CONFIG_DIR" || exit 1
  
  # Check if already a git repo
  if check_git_repo; then
    echo -e "${YELLOW}This directory is already a git repository.${NC}"
    echo "Remote: $(git remote get-url origin 2>/dev/null || echo 'No remote configured')"
    read -p "Reinitialize? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      echo -e "${YELLOW}Cancelled${NC}"
      exit 0
    fi
  fi
  
  echo -e "${BLUE}╔════════════════════════════════════════╗${NC}"
  echo -e "${BLUE}║  Git Repository Setup                  ║${NC}"
  echo -e "${BLUE}╚════════════════════════════════════════╝${NC}"
  echo ""
  
  # Ask if user wants to set up git
  read -p "Version control your fedora-config with git? [Y/n] " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Nn]$ ]]; then
    echo -e "${YELLOW}Skipped git setup${NC}"
    exit 0
  fi
  
  # Ask for platform
  echo ""
  echo "Which platform are you using?"
  echo "  1) GitHub"
  echo "  2) GitLab"
  echo "  3) Other"
  read -p "Choice [1-3]: " platform_choice
  
  case $platform_choice in
    1) platform="GitHub" ;;
    2) platform="GitLab" ;;
    3) platform="Other" ;;
    *) platform="GitHub" ;;
  esac
  
  # Ask if repo is created
  echo ""
  read -p "Have you already created a repository on $platform? [y/N] " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo ""
    echo -e "${BLUE}Please create a repository:${NC}"
    case $platform in
      "GitHub")
        echo "  → https://github.com/new"
        echo "  • Name it something like 'fedora-config' or 'my-fedora-config'"
        echo "  • Make it Private (recommended) or Public"
        echo "  • Don't initialize with README"
        ;;
      "GitLab")
        echo "  → https://gitlab.com/projects/new"
        echo "  • Name it something like 'fedora-config' or 'my-fedora-config'"
        echo "  • Set visibility as desired"
        echo "  • Don't initialize with README"
        ;;
      *)
        echo "  • Create an empty repository on your git platform"
        ;;
    esac
    echo ""
    read -p "Press Enter when done..."
  fi
  
  # Get repository URL
  echo ""
  echo -e "${BLUE}Enter your repository URL${NC}"
  echo "Examples:"
  echo "  HTTPS: https://github.com/username/fedora-config.git"
  echo "  SSH:   git@github.com:username/fedora-config.git"
  read -p "URL: " repo_url
  
  if ! validate_git_url "$repo_url"; then
    echo -e "${RED}Invalid URL format${NC}"
    exit 1
  fi
  
  # Get git user info
  echo ""
  read -p "Git username: " git_user
  read -p "Git email: " git_email
  
  echo ""
  echo -e "${BLUE}Setting up repository...${NC}"
  echo ""
  
  # Initialize git if not already
  if [ ! -d ".git" ]; then
    echo -e "${BLUE}→${NC} Initializing git repository..."
    git init || exit 1
  fi
  
  # Add config.yaml to .gitignore
  echo -e "${BLUE}→${NC} Adding config.yaml to .gitignore..."
  if ! grep -q "^config.yaml$" .gitignore 2>/dev/null; then
    echo "config.yaml" >> .gitignore
  fi
  
  # Configure git user
  echo -e "${BLUE}→${NC} Configuring git user..."
  git config user.name "$git_user"
  git config user.email "$git_email"
  
  # Add files
  echo -e "${BLUE}→${NC} Staging files..."
  git add .
  
  # Create initial commit
  echo -e "${BLUE}→${NC} Creating initial commit..."
  git commit -m "Initial fedora-config setup from $(hostname)" || true
  
  # Add remote
  echo -e "${BLUE}→${NC} Adding remote origin..."
  if git remote get-url origin > /dev/null 2>&1; then
    git remote set-url origin "$repo_url"
  else
    git remote add origin "$repo_url"
  fi
  
  # Push to remote
  echo -e "${BLUE}→${NC} Pushing to remote..."
  if git push -u origin main 2>&1; then
    echo ""
    echo -e "${GREEN}✓ Repository set up successfully!${NC}"
    echo ""
    echo "Your fedora-config is now version controlled at:"
    echo "  $repo_url"
  else
    handle_git_error $? "push"
    echo ""
    echo -e "${YELLOW}Repository configured locally, but push failed.${NC}"
    echo "Fix authentication, then run: cd $FEDORA_CONFIG_DIR && git push -u origin main"
  fi
}

# Clone existing repository
cmd_repo_clone() {
  echo -e "${BLUE}╔════════════════════════════════════════╗${NC}"
  echo -e "${BLUE}║  Clone fedora-config Repository        ║${NC}"
  echo -e "${BLUE}╚════════════════════════════════════════╝${NC}"
  echo ""
  
  # Check if fedora-config exists
  if [ -d "$FEDORA_CONFIG_DIR" ]; then
    echo -e "${YELLOW}fedora-config directory already exists${NC}"
    read -p "Backup and replace? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      echo -e "${YELLOW}Cancelled${NC}"
      exit 0
    fi
  fi
  
  # Get repository URL
  echo "Enter your fedora-config repository URL:"
  echo "Examples:"
  echo "  HTTPS: https://github.com/username/fedora-config.git"
  echo "  SSH:   git@github.com:username/fedora-config.git"
  read -p "URL: " repo_url
  
  if ! validate_git_url "$repo_url"; then
    echo -e "${RED}Invalid URL format${NC}"
    exit 1
  fi
  
  echo ""
  echo -e "${BLUE}Cloning repository...${NC}"
  echo ""
  
  # Backup existing if present
  if [ -d "$FEDORA_CONFIG_DIR" ]; then
    backup_dir="${FEDORA_CONFIG_DIR}.backup.$(date +%s)"
    echo -e "${BLUE}→${NC} Backing up existing fedora-config to:"
    echo "  $backup_dir"
    mv "$FEDORA_CONFIG_DIR" "$backup_dir"
  fi
  
  # Clone repository
  echo -e "${BLUE}→${NC} Cloning from $repo_url..."
  if ! git clone "$repo_url" "$FEDORA_CONFIG_DIR"; then
    handle_git_error $? "clone"
    # Restore backup if clone failed
    if [ -d "$backup_dir" ]; then
      mv "$backup_dir" "$FEDORA_CONFIG_DIR"
    fi
    exit 1
  fi
  
  cd "$FEDORA_CONFIG_DIR" || exit 1
  
  # Auto-detect hostname
  local current_hostname
  current_hostname=$(hostname)
  
  echo ""
  echo -e "${BLUE}→${NC} Configuring for host: ${GREEN}$current_hostname${NC}"
  
  # Update config.yaml
  yq -i ".host = \"$current_hostname\"" config.yaml
  
  # Check if host file exists
  local host_file="packages/hosts/${current_hostname}.yaml"
  if [ -f "$host_file" ]; then
    echo -e "${YELLOW}Host configuration already exists: $host_file${NC}"
  else
    # Ask for description
    echo ""
    read -p "Describe this machine (optional, e.g., 'Gaming Desktop'): " machine_desc
    [ -z "$machine_desc" ] && machine_desc="$current_hostname"
    
    echo -e "${BLUE}→${NC} Creating host-specific configuration..."
    cat > "$host_file" << EOF
# Host-specific packages for $current_hostname
# $machine_desc

description: Packages specific to $current_hostname

# Packages to install only on this host
packages: []

# Packages to exclude from base or modules on this host
exclude: []
EOF
  fi
  
  # Commit changes
  echo -e "${BLUE}→${NC} Committing host configuration..."
  git add .
  git commit -m "Add $current_hostname host configuration" || true
  
  # Push changes
  echo -e "${BLUE}→${NC} Pushing changes..."
  if git push; then
    echo ""
    echo -e "${GREEN}✓ fedora-config cloned and configured successfully!${NC}"
    echo ""
    echo "Next steps:"
    echo "  1. Review: $host_file"
    echo "  2. Run: fcli module list"
    echo "  3. Run: fcli sync"
  else
    handle_git_error $? "push"
    echo ""
    echo -e "${YELLOW}Cloned successfully, but push failed.${NC}"
    echo "Fix authentication, then run: fcli repo push"
  fi
}

# Push changes to remote
cmd_repo_push() {
  cd "$FEDORA_CONFIG_DIR" || exit 1
  
  if ! check_git_repo; then
    echo -e "${RED}Not a git repository${NC}"
    echo "Run 'fcli repo init' first"
    exit 1
  fi
  
  echo -e "${BLUE}Pushing fedora-config changes...${NC}"
  echo ""
  
  # Check for changes
  if ! git diff-index --quiet HEAD -- 2>/dev/null; then
    echo -e "${BLUE}→${NC} Changes detected"
    git status --short
    echo ""
  else
    if ! git diff --quiet 2>/dev/null; then
      echo -e "${BLUE}→${NC} Unstaged changes detected"
    else
      echo -e "${GREEN}No changes to commit${NC}"
      exit 0
    fi
  fi
  
  # Get commit message
  echo ""
  echo "Commit message (or press Enter for default):"
  read -p "> " commit_msg
  
  if [ -z "$commit_msg" ]; then
    commit_msg="Update fedora-config from $(hostname) - $(date '+%Y-%m-%d %H:%M')"
  fi
  
  echo ""
  echo -e "${BLUE}→${NC} Staging changes..."
  git add .
  
  echo -e "${BLUE}→${NC} Committing..."
  git commit -m "$commit_msg"
  
  echo -e "${BLUE}→${NC} Pushing to remote..."
  if git push; then
    echo ""
    echo -e "${GREEN}✓ Changes pushed successfully!${NC}"
  else
    handle_git_error $? "push"
  fi
}

# Pull changes from remote
cmd_repo_pull() {
  cd "$FEDORA_CONFIG_DIR" || exit 1
  
  if ! check_git_repo; then
    echo -e "${RED}Not a git repository${NC}"
    echo "Run 'fcli repo init' or 'fcli repo clone' first"
    exit 1
  fi
  
  echo -e "${BLUE}Pulling updates from remote...${NC}"
  echo ""
  
  echo -e "${BLUE}→${NC} Fetching changes..."
  if git pull; then
    echo ""
    echo -e "${GREEN}✓ Updates pulled successfully!${NC}"
    echo ""
    echo "Run 'fcli sync' to install any new packages"
  else
    handle_git_error $? "pull"
  fi
}

# Show repository status
cmd_repo_status() {
  cd "$FEDORA_CONFIG_DIR" || exit 1
  
  if ! check_git_repo; then
    echo -e "${RED}Not a git repository${NC}"
    echo "Run 'fcli repo init' or 'fcli repo clone' first"
    exit 1
  fi
  
  echo -e "${BLUE}Repository Status:${NC}"
  echo ""
  
  # Show remote
  local remote_url
  remote_url=$(git remote get-url origin 2>/dev/null || echo "No remote configured")
  echo "Remote: $remote_url"
  
  # Show current branch
  local branch
  branch=$(git branch --show-current 2>/dev/null || echo "unknown")
  echo "Branch: $branch"
  echo ""
  
  # Show git status
  git status
  
  echo ""
  echo -e "${BLUE}Tip:${NC} Use 'fcli repo push' to save your changes"
}


# Main command handling
case "${1:-}" in
  help|--help|-h)
    print_help
    exit 0
    ;;
  init)
    cmd_init
    exit 0
    ;;
  update)
    sudo dnf update -y
    ;;

  install)
    if [ $# -lt 2 ]; then
      echo "Error: Please specify a package to install" >&2
      echo "Usage: fcli install <package-name>" >&2
      exit 1
    fi
    shift
    sudo dnf install -y "$@"
    ;;

  remove)
    if [ $# -lt 2 ]; then
      echo "Error: Please specify a package to remove" >&2
      echo "Usage: fcli remove <package-name>" >&2
      exit 1
    fi
    shift
    sudo dnf remove -y "$@"
    ;;

  sync)
    shift
    cmd_sync "$@"
    ;;

  module)
    case "${2:-}" in
      list)
        cmd_module_list
        ;;
      enable)
        if [ $# -lt 3 ]; then
          echo "Error: Please specify a module to enable" >&2
          echo "Usage: fcli module enable <module-name>" >&2
          exit 1
        fi
        cmd_module_enable "$3"
        ;;
      disable)
        if [ $# -lt 3 ]; then
          echo "Error: Please specify a module to disable" >&2
          echo "Usage: fcli module disable <module-name>" >&2
          exit 1
        fi
        cmd_module_disable "$3"
        ;;
      *)
        echo "Error: Unknown module command: ${2:-}" >&2
        echo "Usage: fcli module {list|enable|disable}" >&2
        exit 1
        ;;
    esac
    ;;

  status)
    cmd_status
    ;;

  repo)
    case "${2:-}" in
      init)
        cmd_repo_init
        ;;
      clone)
        cmd_repo_clone
        ;;
      push)
        cmd_repo_push
        ;;
      pull)
        cmd_repo_pull
        ;;
      status)
        cmd_repo_status
        ;;
      *)
        echo "Error: Unknown repo command: ${2:-}" >&2
        echo "Usage: fcli repo {init|clone|push|pull|status}" >&2
        exit 1
        ;;
    esac
    ;;

  backup)
    check_timeshift
    if [ "${2:-}" = "list" ]; then
      sudo timeshift --list
    else
      sudo timeshift --create --comments "fcli backup (manual)"
    fi
    ;;

  restore)
    check_timeshift
    if [ $# -ge 2 ]; then
      sudo timeshift --restore --snapshot "$2"
    else
      sudo timeshift --restore
    fi
    ;;

  -d)
    check_timeshift
    if [ $# -lt 2 ]; then
      echo "Error: Please specify a snapshot to delete" >&2
      echo "Usage: fcli -d <snapshot-name>" >&2
      exit 1
    fi
    sudo timeshift --delete --snapshot "$2"
    ;;

  -c)
    check_timeshift
    if [ "${2:-}" = "backup" ]; then
      sudo timeshift --check
    else
      echo "Error: Unknown option for -c flag" >&2
      echo "Usage: fcli -c backup" >&2
      exit 1
    fi
    ;;

  "")
    echo "Error: No command provided" >&2
    echo "Usage: fcli [command] [options]" >&2
    exit 1
    ;;

  *)
    # Default: pass to dnf as search
    dnf search "$@"
    ;;
esac
